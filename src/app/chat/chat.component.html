<div class="user-form" id="username-page" *ngIf="!nickname">
  <form id="usernameForm">
    <input type="hidden" id="nickname" [value]="currentUser?.email" name="nickname" required>
    <input type="hidden" id="selectedUser" [value]="selectedUser" name="nickname" required>
  </form>
</div>

<div class="chat-container" id="chat-page" *ngIf="nickname">
  <!-- Ğ›ĞµĞ²Ğ°Ñ Ğ¿Ğ°Ğ½ĞµĞ»ÑŒ Ñ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑĞ¼Ğ¸ -->
  <div class="users-panel" [class.hidden-mobile]="showChatOnMobile">
    <div class="users-header">
      <h2>ğŸ’¬ Chats</h2>
      <div class="user-info">
        <p id="connected-user-fullname">{{ nickname }}</p>
        <div class="connection-status" [class.connected]="isConnected" [class.disconnected]="!isConnected">
          <span class="status-dot"></span>
          {{ isConnected ? 'Connected' : 'Disconnected' }}
        </div>
      </div>
    </div>

    <div class="users-list-container">
      <ul id="connectedUsers">
        <li
          *ngFor="let user of allUsers; let i = index"
          class="user-item"
          [id]="user.id"
          (click)="userItemClick(user)">
          <div class="user-avatar">
            <img *ngIf="user.profilePicture" [src]="getImageUrl(user.profilePicture)" [alt]="user.firstName + ' ' + user.lastName" class="user-photo" (error)="onImageError($event)">
            <span *ngIf="!user.profilePicture">{{ user.firstName?.charAt(0) || 'U' }}</span>
          </div>
          <div class="user-info">
            <span class="user-name">{{ user.firstName }} {{ user.lastName }}</span>
            <span class="last-message" *ngIf="getLastMessage(user.id)">{{ getLastMessage(user.id)?.content }}</span>
          </div>
          <span class="nbr-msg hidden">0</span>
        </li>
      </ul>
    </div>

    <div class="users-footer">
      <a class="logout" routerLink="/welcome" id="logout">â† Back</a>
    </div>
  </div>

  <!-- ĞŸÑ€Ğ°Ğ²Ğ°Ñ Ğ¿Ğ°Ğ½ĞµĞ»ÑŒ Ñ Ñ‡Ğ°Ñ‚Ğ¾Ğ¼ -->
  <div class="chat-panel" [class.full-width-mobile]="showChatOnMobile">
    <div class="chat-header" *ngIf="selectedUserId">
      <div class="selected-user-info">
        <button class="back-button-mobile" *ngIf="showChatOnMobile" (click)="showUsersList()" title="Back to users list">
          â† Back
        </button>
        <div class="user-avatar">
          <img *ngIf="getSelectedUser()?.profilePicture" [src]="getImageUrl(getSelectedUser()?.profilePicture)" [alt]="getSelectedUser()?.firstName + ' ' + getSelectedUser()?.lastName" class="user-photo" (error)="onImageError($event)">
          <span *ngIf="!getSelectedUser()?.profilePicture">{{ getSelectedUser()?.firstName?.charAt(0) || 'U' }}</span>
        </div>
        <span>{{ getSelectedUser()?.firstName }} {{ getSelectedUser()?.lastName }}</span>
      </div>
    </div>

    <div class="chat-messages-container">
      <div id="chat-messages" (scroll)="onScroll($event)">
        <div
          *ngFor="let message of messages; let i = index"
          class="message"
          [class.sender]="isMessageFromCurrentUser(message)"
          [class.receiver]="!isMessageFromCurrentUser(message)"
          [title]="'Message ' + i + ': senderId=' + message.senderId + ', currentUserId=' + currentUser.id + ', isFromCurrent=' + isMessageFromCurrentUser(message)">
          <p [innerHTML]="formatMessageContent(message.content)"></p>
        </div>

        <!-- Ğ˜Ğ½Ğ´Ğ¸ĞºĞ°Ñ‚Ğ¾Ñ€ Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ¸ -->
        <div class="loading-indicator" *ngIf="isLoadingMessages">
          <div class="spinner"></div>
          <span>Loading messages...</span>
        </div>
      </div>
    </div>

    <form id="messageForm" name="messageForm" [class.hidden]="!selectedUserId" (ngSubmit)="sendMessage($event)">
      <div class="message-input">
        <textarea
          autocomplete="off"
          id="message"
          placeholder="ğŸ’¬ Type your message..."
          [(ngModel)]="newMessage"
          name="message"
          required
          minlength="1"
          maxlength="1000"
          rows="1"
          (keydown)="onKeyDown($event)"
          (input)="autoResize($event)"
          (focus)="onInputFocus($event)"
          (blur)="onInputBlur($event)">
        </textarea>
        <button
          type="submit"
          [disabled]="!newMessage.trim() || !selectedUserId">
          âœˆï¸ Send
        </button>
      </div>
    </form>
  </div>
</div>
